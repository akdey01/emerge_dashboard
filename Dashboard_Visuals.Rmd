---
title: "Dashboard-Visualizations"
author: "Arnab Dey"
date: "3/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Gloal stuff

```{r load packages, message=FALSE}
library(tidyverse)
library(janitor)
library(wordcloud)
library(tm)
library(RColorBrewer)
library(SnowballC)
```

# Wordcloud
## Create Dataframe

### Load data as corpus
```{r}
text = df_measures$title
docs = Corpus(VectorSource(text)) 
#inspect(docs)
```

### Text transportation
```{r}
toSpace <- content_transformer(function (x , pattern ) gsub(pattern, "", x))
docs1 = tm_map(docs, toSpace, "-")
docs1 = tm_map(docs1, toSpace, "\\(")
docs1 = tm_map(docs1, toSpace, "\\)")
docs1 = tm_map(docs1, toSpace, ":")
docs1 = tm_map(docs1, toSpace, "|")
docs1 = tm_map(docs1, toSpace, "/")
inspect(docs1)
```

## Clean text
```{r}
# Remove numbers
docs2 <- tm_map(docs1, removeNumbers)
# Remove english common stopwords
docs2 <- tm_map(docs2, removeWords, stopwords("english"))
# Remove your own stop word
docs2 <- tm_map(docs2, removeWords, c("and", "AND")) 
# Remove punctuations
docs2 <- tm_map(docs2, removePunctuation)
inspect(docs2)
```


```{r}
dtm <- TermDocumentMatrix(docs2)
m <- as.matrix(dtm)
v <- sort(rowSums(m),decreasing=TRUE)
d <- data.frame(word = names(v),freq=v)
head(d, 10)
```


## Plot - Wordcloud - All
```{r}
set.seed(1234)
wordcloud(words = d$word, freq = d$freq, min.freq = 1,
          max.words=150, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))

```



# Bargraph

## Bargraph for all measures

## Create dataframe
```{r create dataframe}

Dimensions <- c("Psychological \nEmpowerment",
                "Social \nEmpowerment",
                "Education",
                "Legal",
                "Political",
                "Household / \nIntrafamilial \nRelations",
                "Environment and \nSustainability",
                "Time Poverty",
                "Gender \nBased \nViolence",
                "Women's \nEconomic \nEmpowerment",
                "Health",
                "Maternal and \nChild Health",
                "SRH and \nFP",
                "All Measures")

num_measures <- unlist(df_measures %>% select(starts_with("dim")) %>% map(~sum(!is.na(.)))) 
num_measures <- c(num_measures, nrow(df_measures))
df_bar_all <- as.tibble(cbind(Dimensions, num_measures))

df_bar_all <- df_bar_all %>% 
  mutate(num_measures = as.numeric(num_measures))
```

## Plot - Bargraph for all measures
```{r}
plot_bar_all <- ggplot(df_bar_all, aes(fct_reorder(Dimensions, num_measures) , num_measures)) + 
  geom_bar(stat = "identity", width = 0.9, fill = "#157067") + 
  geom_text(aes(label = num_measures), size = 3, vjust = -0.5, color = "black") +
  xlab("Dimensions") + 
  ylab("Number of measures on EMERGE") + 
  theme_minimal()
  
plot_bar_all

```


# Chloropleth

## Create table with count of measures by country 
```{r}

country_list <- df_measures %>% dplyr::select(countries) %>% dplyr::filter(!is.na(countries))

old_countries <- c("Congo, Democratic Republic of the", "Congo, Republic of the", "Micronesia, Federated States of", "Korea, South")
new_countries <- c("Democratic Republic of the Congo", "Republic of the Congo", "Federated States of Micronesia", "South Korea")

country_list$countries <- stringr::str_replace_all(country_list$countries, 
                                                   "Congo, Democratic Republic of the", 
                                                   "Democratic Republic of the Congo")

country_list$countries <- stringr::str_replace_all(country_list$countries, 
                                                   "Congo, Republic of the", 
                                                   "Republic of the Congo")

country_list$countries <- stringr::str_replace_all(country_list$countries, 
                                                   "Micronesia, Federated States of", 
                                                   "Federated States of Micronesia")

country_list$countries <- stringr::str_replace_all(country_list$countries, 
                                                   "Korea, South", 
                                                   "South Korea")

country_list$countries <- stringr::str_replace_all(country_list$countries, 
                                                   "Korea, North", 
                                                   "North Korea")


df_countries <- as.data.frame(unlist(strsplit(country_list$countries, ",")))

colnames(df_countries) <- "countries"

df_countries_n <- df_countries %>% 
  dplyr::count(countries)

```

## Merge the shape file with the Country_measure file
```{r}
df_shape <- as.data.frame(my_spdf@data$NAME)
colnames(df_shape) <- "countries"

df_shape_match <- df_shape %>% 
  dplyr::anti_join(df_countries_n, by = "countries")

```

## plot worldmap
```{r}
# Read this shape file with the rgdal library. 
library(rgdal)
install.packages("rgdal")

dsn= paste0(getwd(),"/geoDATA/world_shape_file/")

my_spdf <- readOGR( 
  dsn= paste0(getwd(),"/geoDATA/world_shape_file") , 
  layer="TM_WORLD_BORDERS_SIMPL-0.3",
  verbose = FALSE)

plot(my_spdf, xlim=c(-20,60) , ylim=c(-60,100))

a <- rnorm(246, 15, 25)

my_spdf@data$measures <- a

# Palette of 30 colors
library(RColorBrewer)
my_colors <- brewer.pal(9, "PuBuGn") 
my_colors <- colorRampPalette(my_colors)(30)

# Attribute the appropriate color to each country
class_of_country <- cut(my_spdf@data$measures, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

# Make the plot
plot(my_spdf , xlim=c(-20,60) , ylim=c(-80,80), col=my_colors ,  bg = "#A6CAE0")

```


# Save Files
```{r save files}
ggsave(filename="Figures/bar_all.png", plot = plot_bar_all, width=10.5, height=5.5, dpi=150)
```



